<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Facebook Native App Authentication</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .test-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .test-section h3 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .result strong {
      color: #667eea;
      display: block;
      margin-bottom: 5px;
    }

    .result-value {
      color: #333;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    button {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .log-entry {
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .log-entry.success { color: #4ec9b0; }
    .log-entry.error { color: #f48771; }
    .log-entry.info { color: #569cd6; }
    .log-entry.warning { color: #dcdcaa; }

    .device-info {
      background: #e3f2fd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 13px;
      line-height: 1.6;
      color: #1565c0;
    }

    .icon {
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Facebook Native Auth Test</h1>
    <p class="subtitle">Test Facebook app detection and authentication flow</p>

    <div class="device-info" id="deviceInfo">
      <strong>Device Information:</strong><br>
      Loading...
    </div>

    <div id="statusMessage" class="status"></div>

    <div class="test-section">
      <h3><span class="icon">üîç</span> Detection Test</h3>
      <button onclick="testDetection()" id="detectBtn">
        Detect Facebook App
      </button>
      <div id="detectionResults"></div>
    </div>

    <div class="test-section">
      <h3><span class="icon">üì±</span> Authentication Test</h3>
      <button onclick="testNativeAuth()" id="authBtn">
        Test Facebook Login Flow
      </button>
    </div>

    <div class="test-section">
      <h3><span class="icon">üìã</span> Console Logs</h3>
      <div id="logContainer" class="log-container"></div>
    </div>
  </div>

  <script type="module">
    let logs = [];

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      logs.push({ timestamp, message, type });
      updateLogDisplay();
    }

    function updateLogDisplay() {
      const container = document.getElementById('logContainer');
      container.innerHTML = logs.map(log =>
        `<div class="log-entry ${log.type}">[${log.timestamp}] ${log.message}</div>`
      ).join('');
      container.scrollTop = container.scrollHeight;
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    function updateDeviceInfo() {
      const ua = navigator.userAgent;
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      const isAndroid = /Android/i.test(ua);
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);

      const info = `
        Platform: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop/Other'}<br>
        Mobile Device: ${isMobile ? 'Yes' : 'No'}<br>
        User Agent: ${ua.substring(0, 80)}...
      `;

      document.getElementById('deviceInfo').innerHTML = `<strong>Device Information:</strong><br>${info}`;
    }

    async function detectFacebookApp() {
      addLog('Starting Facebook app detection...', 'info');

      const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent
      );

      if (!isMobileDevice) {
        addLog('Desktop device detected - skipping detection', 'warning');
        return { isInstalled: false, shouldUseNativeApp: false };
      }

      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isAndroid = /Android/i.test(navigator.userAgent);

      addLog(`Platform: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Unknown'}`, 'info');

      try {
        const detected = await tryDetectFacebookApp(isIOS, isAndroid);
        addLog(`Detection result: ${detected ? 'Facebook app found' : 'Facebook app not found'}`, detected ? 'success' : 'warning');

        return {
          isInstalled: detected,
          shouldUseNativeApp: detected && (isIOS || isAndroid),
        };
      } catch (error) {
        addLog(`Detection error: ${error.message}`, 'error');
        return { isInstalled: false, shouldUseNativeApp: false };
      }
    }

    async function tryDetectFacebookApp(isIOS, isAndroid) {
      return new Promise((resolve) => {
        const timeout = setTimeout(() => {
          addLog('Detection timeout (2s) - assuming app not installed', 'warning');
          resolve(false);
        }, 2000);

        if (isIOS) {
          addLog('Using iOS detection method (iframe + fb:// scheme)', 'info');
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = 'fb://';

          document.body.appendChild(iframe);

          setTimeout(() => {
            document.body.removeChild(iframe);
            clearTimeout(timeout);

            const appOpened = document.hidden || document.webkitHidden;
            addLog(`iOS detection: ${appOpened ? 'App switched' : 'No app switch detected'}`, appOpened ? 'success' : 'info');
            resolve(appOpened);
          }, 1000);
        } else if (isAndroid) {
          addLog('Using Android detection method (link + fb://page)', 'info');
          const testLink = document.createElement('a');
          testLink.href = 'fb://page';
          testLink.style.display = 'none';
          document.body.appendChild(testLink);

          const startTime = Date.now();
          testLink.click();

          setTimeout(() => {
            const elapsedTime = Date.now() - startTime;
            document.body.removeChild(testLink);
            clearTimeout(timeout);

            const appOpened = elapsedTime < 1500 || document.hidden || document.webkitHidden;
            addLog(`Android detection: Elapsed ${elapsedTime}ms, Hidden: ${document.hidden}`, appOpened ? 'success' : 'info');
            resolve(appOpened);
          }, 1000);
        } else {
          clearTimeout(timeout);
          addLog('Unknown platform - cannot detect', 'warning');
          resolve(false);
        }
      });
    }

    window.testDetection = async function() {
      const btn = document.getElementById('detectBtn');
      const results = document.getElementById('detectionResults');

      btn.disabled = true;
      btn.textContent = 'Detecting...';
      results.innerHTML = '';
      logs = [];

      try {
        const detection = await detectFacebookApp();

        results.innerHTML = `
          <div class="result">
            <strong>Facebook App Installed:</strong>
            <div class="result-value">${detection.isInstalled ? '‚úÖ Yes' : '‚ùå No'}</div>
          </div>
          <div class="result">
            <strong>Should Use Native App:</strong>
            <div class="result-value">${detection.shouldUseNativeApp ? '‚úÖ Yes' : '‚ùå No'}</div>
          </div>
          <div class="result">
            <strong>Recommended Flow:</strong>
            <div class="result-value">${detection.shouldUseNativeApp ? 'üì± Native App Authentication' : 'üåê Web-Based Authentication'}</div>
          </div>
        `;

        showStatus(
          detection.isInstalled
            ? 'Facebook app detected! Will use native authentication.'
            : 'Facebook app not found. Will use web-based authentication.',
          detection.isInstalled ? 'success' : 'info'
        );

        addLog('Detection test completed successfully', 'success');
      } catch (error) {
        results.innerHTML = `<div class="result"><strong>Error:</strong><div class="result-value">${error.message}</div></div>`;
        showStatus('Detection test failed', 'error');
        addLog(`Test failed: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Detect Facebook App';
      }
    };

    window.testNativeAuth = async function() {
      const btn = document.getElementById('authBtn');

      btn.disabled = true;
      btn.textContent = 'Testing...';
      logs = [];

      addLog('Starting authentication flow test...', 'info');

      try {
        const detection = await detectFacebookApp();

        if (detection.shouldUseNativeApp) {
          addLog('Would open Facebook native app for authentication', 'success');
          showStatus('Test successful! In production, Facebook app would open now.', 'success');
        } else {
          addLog('Would open web-based Facebook login', 'info');
          showStatus('Test successful! In production, browser would open for Facebook login.', 'info');
        }

        addLog('Authentication flow test completed', 'success');
      } catch (error) {
        showStatus('Authentication test failed', 'error');
        addLog(`Test failed: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test Facebook Login Flow';
      }
    };

    updateDeviceInfo();
    addLog('Test page loaded successfully', 'success');
    addLog('Ready to test Facebook app detection', 'info');
  </script>
</body>
</html>
