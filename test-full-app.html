<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Full App Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    .test-item {
      padding: 10px;
      margin: 10px 0;
      border-left: 4px solid #ccc;
      background: #f9f9f9;
    }
    .test-item.pending {
      border-left-color: #ffa500;
    }
    .test-item.pass {
      border-left-color: #4caf50;
      background: #f1f8f4;
    }
    .test-item.fail {
      border-left-color: #f44336;
      background: #fef1f0;
    }
    .test-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .test-item pre {
      margin: 5px 0;
      padding: 10px;
      background: #fff;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 10px 10px 0;
    }
    button:hover {
      background: #1976D2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .summary {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .summary-card {
      flex: 1;
      padding: 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
    }
    .summary-card.total { background: #2196F3; }
    .summary-card.pass { background: #4caf50; }
    .summary-card.fail { background: #f44336; }
    .summary-card h3 { margin: 0; font-size: 32px; }
    .summary-card p { margin: 5px 0 0 0; }
  </style>
</head>
<body>
  <h1>üß™ Full App Test Suite</h1>

  <div class="summary" id="summary" style="display: none;">
    <div class="summary-card total">
      <h3 id="total-tests">0</h3>
      <p>Total Tests</p>
    </div>
    <div class="summary-card pass">
      <h3 id="pass-tests">0</h3>
      <p>Passed</p>
    </div>
    <div class="summary-card fail">
      <h3 id="fail-tests">0</h3>
      <p>Failed</p>
    </div>
  </div>

  <button onclick="runAllTests()">Run All Tests</button>
  <button onclick="testSupabase()">Test Supabase Only</button>
  <button onclick="testAPI()">Test External API Only</button>
  <button onclick="clearResults()">Clear Results</button>

  <div class="test-section">
    <h2>1Ô∏è‚É£ Supabase Database Tests</h2>
    <div id="supabase-tests"></div>
  </div>

  <div class="test-section">
    <h2>2Ô∏è‚É£ Supabase Edge Functions Tests</h2>
    <div id="edge-tests"></div>
  </div>

  <div class="test-section">
    <h2>3Ô∏è‚É£ External API Tests</h2>
    <div id="api-tests"></div>
  </div>

  <div class="test-section">
    <h2>4Ô∏è‚É£ Authentication Tests</h2>
    <div id="auth-tests"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://dopjawhuylqipltnuydp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvcGphd2h1eWxxaXBsdG51eWRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDA0NTksImV4cCI6MjA3NjIxNjQ1OX0.l_xbP6PPkTsq82CnFQ6caHFWyKf1fwkvYqBmzpp03Co';
    const API_BASE_URL = 'https://api.pawatasty.com';
    const API_KEY = 'b0834cfeae781e2c13213b55741d2717';
    const API_SECRET = 'db0572a02b9aa963b0138e7180ba994fa730ddf63cfc5b60798c15a234b6523f';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let testResults = {
      total: 0,
      passed: 0,
      failed: 0
    };

    window.supabase = supabase;

    function addTestResult(containerId, testName, status, details) {
      const container = document.getElementById(containerId);
      const testItem = document.createElement('div');
      testItem.className = `test-item ${status}`;

      const icon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥';
      testItem.innerHTML = `
        <strong>${icon} ${testName}</strong>
        ${details ? `<pre>${details}</pre>` : ''}
      `;

      container.appendChild(testItem);

      testResults.total++;
      if (status === 'pass') testResults.passed++;
      if (status === 'fail') testResults.failed++;

      updateSummary();
    }

    function updateSummary() {
      document.getElementById('summary').style.display = 'flex';
      document.getElementById('total-tests').textContent = testResults.total;
      document.getElementById('pass-tests').textContent = testResults.passed;
      document.getElementById('fail-tests').textContent = testResults.failed;
    }

    async function testSupabaseTables() {
      const tables = [
        'restaurants',
        'bookings',
        'chat_messages',
        'booking_history',
        'deal_bookings',
        'user_profiles',
        'payment_methods',
        'fault_reports',
        'suggestions'
      ];

      for (const table of tables) {
        try {
          const { data, error } = await supabase.from(table).select('*').limit(1);

          if (error) {
            if (error.message.includes('does not exist') || error.message.includes('relation')) {
              addTestResult('supabase-tests', `Table: ${table}`, 'fail',
                `Table does not exist in database\n${error.message}`);
            } else {
              addTestResult('supabase-tests', `Table: ${table}`, 'fail',
                `Error: ${error.message}`);
            }
          } else {
            addTestResult('supabase-tests', `Table: ${table}`, 'pass',
              `Table exists and is accessible`);
          }
        } catch (err) {
          addTestResult('supabase-tests', `Table: ${table}`, 'fail',
            `Exception: ${err.message}`);
        }
      }
    }

    async function testEdgeFunctions() {
      const functions = [
        { name: 'payment-methods', endpoint: '/functions/v1/payment-methods' },
        { name: 'fault-reports', endpoint: '/functions/v1/fault-reports' },
        { name: 'suggestions', endpoint: '/functions/v1/suggestions' }
      ];

      for (const func of functions) {
        try {
          const response = await fetch(`${SUPABASE_URL}${func.endpoint}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.status === 401) {
            addTestResult('edge-tests', `Edge Function: ${func.name}`, 'pass',
              `Function deployed and responding (requires auth)`);
          } else if (response.status === 404) {
            addTestResult('edge-tests', `Edge Function: ${func.name}`, 'fail',
              `Function not deployed (404)`);
          } else {
            const text = await response.text();
            addTestResult('edge-tests', `Edge Function: ${func.name}`, 'pass',
              `Status: ${response.status}\n${text.substring(0, 200)}`);
          }
        } catch (err) {
          addTestResult('edge-tests', `Edge Function: ${func.name}`, 'fail',
            `Error: ${err.message}`);
        }
      }
    }

    async function testExternalAPI() {
      const endpoints = [
        { name: 'Categories', path: '/api/mobile/categories' },
        { name: 'Merchants', path: '/api/mobile/merchants' },
        { name: 'Deals', path: '/api/mobile/deals' }
      ];

      for (const endpoint of endpoints) {
        try {
          const response = await fetch(`${API_BASE_URL}${endpoint.path}`, {
            headers: {
              'X-API-Key': API_KEY,
              'X-API-Secret': API_SECRET
            }
          });

          if (response.ok) {
            const data = await response.json();
            const count = data.data ? data.data.length : 0;
            addTestResult('api-tests', `API: ${endpoint.name}`, 'pass',
              `Status: ${response.status}\nReturned ${count} items`);
          } else {
            const text = await response.text();
            addTestResult('api-tests', `API: ${endpoint.name}`, 'fail',
              `Status: ${response.status}\n${text.substring(0, 200)}`);
          }
        } catch (err) {
          addTestResult('api-tests', `API: ${endpoint.name}`, 'fail',
            `Error: ${err.message}`);
        }
      }
    }

    async function testAuthentication() {
      const testEmail = `test${Date.now()}@example.com`;
      const testPassword = 'TestPass123!';

      try {
        const { data, error } = await supabase.auth.signUp({
          email: testEmail,
          password: testPassword
        });

        if (error) {
          addTestResult('auth-tests', 'Supabase Auth Signup', 'fail',
            `Error: ${error.message}`);
        } else if (data.user) {
          addTestResult('auth-tests', 'Supabase Auth Signup', 'pass',
            `User created: ${data.user.id}`);

          await supabase.auth.signOut();

          const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
            email: testEmail,
            password: testPassword
          });

          if (loginError) {
            addTestResult('auth-tests', 'Supabase Auth Login', 'fail',
              `Error: ${loginError.message}`);
          } else {
            addTestResult('auth-tests', 'Supabase Auth Login', 'pass',
              `Login successful`);
            await supabase.auth.signOut();
          }
        }
      } catch (err) {
        addTestResult('auth-tests', 'Authentication', 'fail',
          `Exception: ${err.message}`);
      }
    }

    window.testSupabase = async function() {
      document.getElementById('supabase-tests').innerHTML = '';
      document.getElementById('edge-tests').innerHTML = '';
      await testSupabaseTables();
      await testEdgeFunctions();
    };

    window.testAPI = async function() {
      document.getElementById('api-tests').innerHTML = '';
      await testExternalAPI();
    };

    window.runAllTests = async function() {
      clearResults();

      addTestResult('supabase-tests', 'Starting Supabase tests...', 'pending', '');
      await testSupabaseTables();

      addTestResult('edge-tests', 'Starting Edge Function tests...', 'pending', '');
      await testEdgeFunctions();

      addTestResult('api-tests', 'Starting External API tests...', 'pending', '');
      await testExternalAPI();

      addTestResult('auth-tests', 'Starting Authentication tests...', 'pending', '');
      await testAuthentication();
    };

    window.clearResults = function() {
      document.getElementById('supabase-tests').innerHTML = '';
      document.getElementById('edge-tests').innerHTML = '';
      document.getElementById('api-tests').innerHTML = '';
      document.getElementById('auth-tests').innerHTML = '';
      testResults = { total: 0, passed: 0, failed: 0 };
      document.getElementById('summary').style.display = 'none';
    };

    console.log('Test suite loaded. Click "Run All Tests" to begin.');
  </script>
</body>
</html>
