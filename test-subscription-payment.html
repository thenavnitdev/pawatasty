<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Subscription Payment Flow</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; font-size: 24px; margin-bottom: 20px; }
        .step {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .step.success { border-color: #4CAF50; background: #f1f8f4; }
        .step.error { border-color: #f44336; background: #fef1f1; }
        .step.loading { border-color: #2196F3; background: #e3f2fd; }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 5px;
        }
        button:hover { background: #ff5722; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #card-element {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Subscription Payment Diagnostics</h1>

        <div class="step" id="step1">
            <strong>Step 1: Check Configuration</strong>
            <div id="config-status">Checking...</div>
        </div>

        <div class="step" id="step2">
            <strong>Step 2: Authentication</strong>
            <div id="auth-status">Waiting...</div>
        </div>

        <div class="input-group">
            <label>Select Plan:</label>
            <select id="plan-select">
                <option value="silver">Silver - ‚Ç¨17/month</option>
                <option value="gold">Gold - ‚Ç¨144/year</option>
            </select>
        </div>

        <div class="step" id="step3">
            <strong>Step 3: Add Payment Method</strong>
            <div id="card-element"></div>
            <div id="card-status" style="margin-top: 10px;"></div>
            <button id="add-card-btn" onclick="addPaymentMethod()" disabled>Add Card</button>
        </div>

        <div class="step" id="step4">
            <strong>Step 4: Create Subscription</strong>
            <div id="subscription-status">Waiting...</div>
            <button id="create-sub-btn" onclick="createSubscription()" disabled>Create Subscription</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dopjawhuylqipltnuydp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvcGphd2h1eWxxaXBsdG51eWRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDA0NTksImV4cCI6MjA3NjIxNjQ1OX0.l_xbP6PPkTsq82CnFQ6caHFWyKf1fwkvYqBmzpp03Co';
        const STRIPE_PK = 'pk_test_51M2D1ECcTUIOQ9MlHx82jO3oGqleOMKvBub1sYxHYTODiKzxwwAWb3hUiqgvHXCf92WXbklGIYgjLtpvh5DiQ9ll00eCtUxgsy';

        let stripe, elements, cardElement;
        let accessToken = null;
        let userId = null;
        let paymentMethodId = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logEl.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        async function init() {
            // Step 1: Check configuration
            try {
                stripe = Stripe(STRIPE_PK);
                document.getElementById('config-status').innerHTML = '‚úÖ Stripe initialized successfully';
                document.getElementById('step1').className = 'step success';
                log('Stripe initialized with publishable key', 'success');
            } catch (error) {
                document.getElementById('config-status').innerHTML = '‚ùå Failed to initialize Stripe: ' + error.message;
                document.getElementById('step1').className = 'step error';
                log('Stripe initialization error: ' + error.message, 'error');
                return;
            }

            // Initialize Stripe Elements
            elements = stripe.elements();
            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#32325d',
                        '::placeholder': { color: '#aab7c4' }
                    }
                }
            });
            cardElement.mount('#card-element');

            cardElement.on('change', (event) => {
                const statusEl = document.getElementById('card-status');
                if (event.error) {
                    statusEl.innerHTML = '‚ùå ' + event.error.message;
                    statusEl.style.color = 'red';
                } else if (event.complete) {
                    statusEl.innerHTML = '‚úÖ Card details complete';
                    statusEl.style.color = 'green';
                    document.getElementById('add-card-btn').disabled = false;
                } else {
                    statusEl.innerHTML = '';
                }
            });

            // Step 2: Check authentication
            checkAuth();
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${localStorage.getItem('supabase.auth.token') || ''}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    userId = data.id;
                    accessToken = localStorage.getItem('supabase.auth.token');
                    document.getElementById('auth-status').innerHTML = `‚úÖ Authenticated as: ${data.email}`;
                    document.getElementById('step2').className = 'step success';
                    document.getElementById('step3').className = 'step';
                    log('User authenticated: ' + data.email, 'success');
                } else {
                    document.getElementById('auth-status').innerHTML = '‚ùå Not authenticated. Please log in to your app first.';
                    document.getElementById('step2').className = 'step error';
                    log('Not authenticated', 'error');
                }
            } catch (error) {
                document.getElementById('auth-status').innerHTML = '‚ùå Auth check failed: ' + error.message;
                document.getElementById('step2').className = 'step error';
                log('Auth check error: ' + error.message, 'error');
            }
        }

        async function addPaymentMethod() {
            const btn = document.getElementById('add-card-btn');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            document.getElementById('step3').className = 'step loading';

            log('Creating Stripe payment method...');

            try {
                // Create payment method with Stripe
                const { error, paymentMethod } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                });

                if (error) {
                    throw new Error(error.message);
                }

                log('Stripe payment method created: ' + paymentMethod.id, 'success');

                // Save to backend
                log('Saving payment method to backend...');
                const response = await fetch(`${SUPABASE_URL}/functions/v1/payment-methods`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'card',
                        stripePaymentMethodId: paymentMethod.id,
                        isPrimary: true,
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save payment method');
                }

                const result = await response.json();
                paymentMethodId = result.id;

                document.getElementById('step3').className = 'step success';
                document.getElementById('card-status').innerHTML = '‚úÖ Payment method added successfully!';
                document.getElementById('card-status').style.color = 'green';
                document.getElementById('create-sub-btn').disabled = false;
                document.getElementById('step4').className = 'step';

                log('Payment method saved to backend: ' + paymentMethodId, 'success');
                btn.textContent = '‚úÖ Card Added';

            } catch (error) {
                document.getElementById('step3').className = 'step error';
                document.getElementById('card-status').innerHTML = '‚ùå ' + error.message;
                document.getElementById('card-status').style.color = 'red';
                log('Payment method error: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Try Again';
            }
        }

        async function createSubscription() {
            const btn = document.getElementById('create-sub-btn');
            btn.disabled = true;
            btn.textContent = 'Creating...';
            document.getElementById('step4').className = 'step loading';

            const tier = document.getElementById('plan-select').value;
            log(`Creating ${tier} subscription...`);

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/subscriptions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tier: tier,
                        paymentMethodId: paymentMethodId,
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Subscription creation failed');
                }

                const result = await response.json();
                document.getElementById('step4').className = 'step success';
                document.getElementById('subscription-status').innerHTML = `‚úÖ Subscription created successfully!<br>Subscription ID: ${result.subscriptionId}`;
                log('Subscription created: ' + result.subscriptionId, 'success');
                btn.textContent = '‚úÖ Subscription Created';

            } catch (error) {
                document.getElementById('step4').className = 'step error';
                document.getElementById('subscription-status').innerHTML = '‚ùå ' + error.message;
                log('Subscription error: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Try Again';
            }
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
